{% extends "admin/base.html" %}
{% block extrahead %}
{% load static %}
<script src="{% static 'plotly/plotly-2.27.0.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/all.min.css' %}"/> 
<script src="{% static 'agrid/30.0.6_dist_ag-grid-enterprise.js' %}"></script> 
<title>Data Entry Defective</title>

{% endblock extrahead %}
{% block content_title %}{% endblock %}
{% block content %}
<div class="container-fluid1">
    <div class="row">
        <div class="{% if hide_right_sidebar %} col-md-12 {% else %} col-md-9 {% endif %}">
            <div class="row">
                <div class="col-md-12">
                    <table class="table table-bordered table-sm table-hover">
                        <thead class="toptable">
                            <tr>
                                <th class="toptable">
                                    S#
                                </th>
                                <th class="toptable">
                                    {{ LABELS.equipment }}
                                </th>
                                <th class="toptable">
                                    {{ LABELS.part }}
                                </th>  
                                <th class="toptable">
                                    {{ LABELS.variable }}
                                </th>
                                <th class="toptable">
                                    LSL
                                </th>
                                <th class="toptable">
                                    Target
                                </th>
                                <th class="toptable">
                                    USL
                                </th>
                                <th class="toptable">
                                    Hist. Mean
                                </th>
                                <th class="toptable">
                                    Hist. Sigma
                                </th>
                                <th class="toptable">
                                    Data Entry
                                </th>
                                <th class="toptable">
                                    Analysis
                                </th>     
                            </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td class="toptable"><a href="{% url 'admin:app1_mapspcscheme_change' scheme.pk %}" target="_blank">{{scheme.pk}}</a></td>
                            <td class="toptable">{{ scheme.equipment_id }}</td>
                            <td class="toptable">{{ scheme.part_vc_id.part_id }}</td>
                            <td class="toptable">{{ scheme.part_vc_id.vc_id }}</td>
                            <td class="toptable">{{ scheme.part_vc_id.lower_spec_limit }}</td>
                            <td class="toptable">{{ scheme.part_vc_id.target_value }}</td>
                            <td class="toptable">{{ scheme.part_vc_id.upper_spec_limit }}</td>
                            <td class="toptable">{{ scheme.historical_mu}}</td>
                            <td class="toptable">{{ scheme.historical_sigma}}</td>
                            <td class="toptable"><a href="{% url 'app1:dataentry_individual' scheme.pk %}">Single</a> | <a href="{% url 'app1:dataentry_imr_bulk' scheme.pk %}">Bulk</a></td>
                            <td class="toptable"><a href="{% url 'app1:imranalysis' scheme.pk %}">I-MR</a> | <a href="{% url 'app1:processcapabilityindividual' scheme.pk %}">Capability</a> | <a href="{% url 'app1:analysis_view' scheme.pk %}">Compare</a> | <a href="{% url 'app1:realtime_imr_chart_refresh' scheme.pk %}">Auto Refresh</a></td>
                        </tr>
                        </tbody>
                    </table> 

                </div>
            </div>
                     
            <div id="chartIDiv" style="width: 100%; height: 400px;"></div>
            <div id="chartMRDiv" style="width: 100%; height: 400px;"></div>
            <div id="gridDiv" class="ag-theme-alpine" style="display: none; width: 100%; height: 400px;"></div>
            <div id="errorDiv" style="width: 100%; height: 200px;"></div>

        </div>
        {% if hide_right_sidebar %}
        {% else %}
        <div class="col-md-3 r-box">
            <form  id="analysisForm"  mcguffin="form-group" action="" method="post" class="form-group" style="text-align: center;">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active">
                            <div class="row">
                                <div class="col-md-12 mt-3">
                                    <table class="table text-left table-bordered table-sm table-hover">
                                        {% csrf_token %}
                                        {% if form.errors %}
                                        {{ form.errors }}
                                        {% endif %}
                                        <tr>
                                            <td style="vertical-align: middle;"> Timezone </td>
                                            <td>{{work_unit_timezone}}</td>
                                        </tr>
                                        <tr>
                                            <td style="vertical-align: middle;">Last N Records</td>
                                            <td>
                                                <input type="number" id="last_n_records" name="last_n_records" value="31" min="1" max="1000">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="vertical-align: middle;">Refresh Rate (minutes)</td>
                                            <td><input type="number" id="refresh_rate" name="refresh_rate" value="1" step="0.1" min="0.5" max="30"></td>
                                        </tr>
                                        {% if scheme.historical_mu %}
                                        <tr>
                                            <td style="vertical-align: middle;">Use historical Mean </td>
                                            <td><input type="checkbox" id="historical_mu" name="historical_mu" ></td>
                                        </tr>
                                        {% endif %}
                                        {% if scheme.historical_sigma %}
                                        <tr>
                                            <td style="vertical-align: middle;">Use historical Sigma </td>
                                            <td><input type="checkbox" id="historical_sigma" name="historical_sigma" ></td>
                                        </tr>
                                        {% endif %}

                                        <tr>
                                            <td style="vertical-align: middle;">Show MR chart</td>
                                            <td><input type="checkbox" id="display_mr_chart" name="display_mr_chart"></td>
                                        </tr>

                                        <tr>
                                            <td style="vertical-align: middle;">Display Raw Data</td>
                                            <td><input type="checkbox" id="display_raw_data" name="display_raw_data"></td>
                                        </tr>
                                        <!-- <tr>
                                            <td>Hide Sidebar</td>
                                            <td><input type="checkbox" id="hide_sidebar" name="hide_sidebar"></td>
                                        </tr> -->
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    <!-- <input type="submit" name="Submit" class="r-button" value="Submit"> -->
            </form>
                <div class="text-left">
                    <p class="section-header">Quick Navigation</p>
                    {{group_data_entry_df_html | safe}}
                    {{related_variable_schemes_df_html | safe}}
                    {{related_defective_schemes_df_html | safe}}
                    {{related_defect_schemes_df_html | safe}}
                </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    var schemeId = "{{ scheme_id }}";
    var intervalId;
    var endpoint = "{% url 'app1:refresh_imr_chart_data' scheme_id %}";
    const i_graph_title = "{{i_graph_title | safe}}"
    const mr_graph_title = "{{mr_graph_title | safe}}"
    const yaxis_title = "{{yaxis_title | safe}}"
    
    function fetchData() {
        // Get the checkbox state
        // var useHistoricalP = "{{historical_p | safe }}";
        var useHistoricalmu = $('#historical_mu').is(':checked');
        var useHistoricalsigma = $('#historical_sigma').is(':checked');
        var includeRawData = $('#display_raw_data').is(':checked');
        var includeMRChart = $('#display_mr_chart').is(':checked');
        var lastNRecords = $('#last_n_records').val() || 31; // default 31
        var url = endpoint  + '?use_historical_mu=' + useHistoricalmu 
                            + '&use_historical_sigma=' + useHistoricalsigma
                            +'&include_raw_data=' + includeRawData
                            + '&last_n_records=' + lastNRecords;
                            
        var loginUrl = "{{ login_url | safe}}";

        $.ajax({
            url: url,
            method: 'GET',
            // success: function(response) {
            //     plotChart(response.data,response.controllines,response.settings,response.historical_mu,response.historical_sigma);
            //     if (response.raw_data && includeRawData) {
            //         displayRawData(response.raw_data,response.relevant_choice_keys,response.relevant_text_keys);
            //     } else {
            //         $('#gridDiv').hide();
            //     }
            // },
            success: function(response) {
                // If API sent an error message, show it and stop further chart rendering
                if (response.error_msg) {
                    $('#errorDiv').html(`
                        <div style="
                            border: 1px solid #ccc;
                            background-color: #fef4f4;
                            color: #333;
                            padding: 20px;
                            margin-top: 20px;
                            border-radius: 8px;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            max-width: 900px;
                        ">
                            <h2 style="margin-top: 0; color: #c00;">${response.error_msg}</h2>
                        </div>
                    `);
                    $('#chartIDiv').hide();
                    $('#chartMRDiv').hide();
                    $('#gridDiv').hide();
                    return; // Stop here
                }

                // No error — clear errorDiv and show chart
                $('#errorDiv').empty();
                $('#chartIDiv').show();

                plotIChart(
                    response.i_data,
                    response.controllines,
                    response.settings,
                    response.historical_mu,
                    response.historical_sigma,
                    response.i_violations,
                    response.id_links
                );

                if (includeMRChart) {
                    $('#chartMRDiv').show();   // ✅ show explicitly
                    plotMRChart(
                        response.mr_data,
                        response.controllines,
                        response.settings,
                        response.mr_violations
                    );
                } else {
                    // ✅ IMPORTANT FIX
                    $('#chartMRDiv').hide();    // hide container
                    Plotly.purge('chartMRDiv'); // remove existing plot
                }
                // plotMRChart(
                //     response.mr_data,
                //     response.controllines,
                //     response.settings,
                //     response.mr_violations  
                // )
                if (response.raw_data && includeRawData) {
                    displayRawData(response.raw_data, response.relevant_choice_keys, response.relevant_text_keys);
                } else {
                    $('#gridDiv').hide();
                }
            },

            error: function(xhr, status, error) {
                if (xhr.status === 401 || xhr.status === 403) {  // Handle both 401 and 403
                    $('#errorDiv').html(`
                        <div style="
                            border: 1px solid #ccc;
                            background-color: #fef4f4;
                            color: #333;
                            padding: 20px;
                            margin-top: 20px;
                            border-radius: 8px;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            max-width: 900px;
                        ">
                            <h3 style="margin-top: 0; color: #c00;">Session Expired</h3>
                            <p >
                                You have been logged out due to inactivity or session expiration.
                                Please <a href="${loginUrl}" id="loginRedirect" style="color: #007BFF; text-decoration: underline;">Log in</a> to continue accessing the real-time P chart.
                            </p>
                            <p style="margin-top: 10px; ">
                                You will be automatically redirected to the Loginpage in <strong style="color: #007BFF">60 seconds</strong>.
                            </p>
                        </div>
                    `);

                    // Stop auto-refresh
                    if (intervalId) {
                        clearInterval(intervalId);
                        intervalId = null;
                    }

                    $('#analysisForm').hide(); 
                    $('#gridDiv').hide();
                    $('#chartIDiv').hide();  
                    $('#chartMRDiv').hide();  

                    // Redirect after 60 seconds to homepage
                    setTimeout(function() {
                        window.location.href = window.location.pathname;
                    }, 60 * 1000);

                    // Redirect immediately if user clicks the "Login again" link
                    $(document).on('click', '#loginRedirect', function(e) {
                        e.preventDefault();
                        window.location.href = window.location.pathname;
                    });
                } else {
                    console.error('Unexpected error:', xhr.status, error);
                    $('#chartIDiv').html('An error occurred while fetching data.');
                }
            }

       
        });
    }

    // I-CHART CLICK HANDLER (KEY FIX)
    function attachIChartClickHandler() {
        const plotDiv = document.getElementById("chartIDiv");
        if (!plotDiv) return;

        // Remove old handlers (important for auto refresh)
        plotDiv.removeAllListeners?.('plotly_click');

        plotDiv.on('plotly_click', function (event) {
            const point = event.points[0];
            const recordId = point.customdata;
            currentRecordId = recordId;

            if (recordId) {
                fetchRecordDetails(recordId);
            }
        });
    }

    

    function plotIChart(data, controllines, settings, historical_mu, historical_sigma, violations, id_links) {
        if (data.length <= 4 || !controllines || !controllines.i_cl) {
            $('#chartIDiv').html('Not enough data or invalid control lines for I chart');
            return;
        }
        // Reverse data to plot from oldest to newest (since backend sorts by -time_stamp)
        data = data.reverse();
        const xRange = Array.from({ length: data.length }, (_, i) => i + 1);
        const timeStamps = data.map(d => d.time_stamp);
        const dataPoints = data.map(d => d.data_point);
        const legend_decimal = settings.legend_decimals;

        // Initialize traces
        const traces = [
            {
                x: xRange,
                y: dataPoints,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Observations',
                line: { color: 'cornflowerblue', width: 1 },
                marker: { size: 7 },
                opacity: 0.8,
                text: timeStamps,
                customdata: id_links,    // ⭐ ADD THIS LINE
                hovertemplate: '%{y}, %{text}'
            },
            {
                x: xRange,
                y: Array(xRange.length).fill(controllines.i_cl),
                type: 'scatter',
                mode: 'lines',
                name: 'CL',
                line: { dash: 'dash', color: 'black', shape: 'hvh' },
                opacity: 0.8,
                showlegend: false
            }
        ];

        // Add control and spec lines based on settings
        if (settings.show_3sl_upper) {
            traces.push({
                x: xRange,
                y: Array(xRange.length).fill(controllines.i_ucl),
                type: 'scatter',
                mode: 'lines',
                name: 'UCL',
                line: { color: 'red', shape: 'hvh' },
                opacity: 0.8,
                showlegend: false
            });
        }
        
        if (settings.show_3sl_lower) {
            traces.push({
                x: xRange,
                y: Array(xRange.length).fill(controllines.i_lcl),
                type: 'scatter',
                mode: 'lines',
                name: 'LCL',
                line: { color: 'red', shape: 'hvh' },
                opacity: 0.8,
                showlegend: false
            });
        }
    
        if (settings.show_2sl_upper) {
            traces.push({
                x: xRange,
                y: Array(xRange.length).fill(controllines.i_2su),
                type: 'scatter',
                mode: 'lines',
                name: 'U2sL',
                line: { dash: 'dot', color: 'red', shape: 'hvh' },
                opacity: 0.8,
                showlegend: false
            });
        }
    
        if (settings.show_2sl_lower) {
            traces.push({
                x: xRange,
                y: Array(xRange.length).fill(controllines.i_2sl),
                type: 'scatter',
                mode: 'lines',
                name: 'L2sL',
                line: { dash: 'dot', color: 'red', shape: 'hvh' },
                opacity: 0.8,
                showlegend: false
            });
        }
        
        if (settings.show_usl && controllines.usl !== null) {
            traces.push({
                x: xRange,
                y: Array(xRange.length).fill(controllines.usl),
                type: 'scatter',
                mode: 'lines',
                name: 'USL',
                line: { color: 'blue', shape: 'hvh' },
                opacity: 0.8,
                showlegend: false
            });
        }
        
        if (settings.show_lsl && controllines.lsl !== null) {
            traces.push({
                x: xRange,
                y: Array(xRange.length).fill(controllines.lsl),
                type: 'scatter',
                mode: 'lines',
                name: 'LSL',
                line: { color: 'blue', shape: 'hvh' },
                opacity: 0.8,
                showlegend: false
            });
        }

        // Add SPC Rule violation traces
        if (settings.rule_1_b) {
            if (settings.show_3sl_upper_alerts && violations.rule1_above.length > 0) {
                traces.push({
                    x: violations.rule1_above.map(i => xRange[i]),
                    y: violations.rule1_above.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-1: Above UCL',
                    marker: { color: 'darkred', size: 9, symbol: 'circle' },
                    text: violations.rule1_above.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
            if (settings.show_3sl_lower_alerts && violations.rule1_below.length > 0) {
                traces.push({
                    x: violations.rule1_below.map(i => xRange[i]),
                    y: violations.rule1_below.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-1: Below LCL',
                    marker: { color: 'darkred', size: 9, symbol: 'circle' },
                    text: violations.rule1_below.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
        }

        if (settings.rule_2_b) {
            if (violations.rule2_above.length > 0) {
                traces.push({
                    x: violations.rule2_above.map(i => xRange[i]),
                    y: violations.rule2_above.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-2: Above CL',
                    marker: { color: 'orange', size: 11, symbol: 'circle' },
                    text: violations.rule2_above.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
            if (violations.rule2_below.length > 0) {
                traces.push({
                    x: violations.rule2_below.map(i => xRange[i]),
                    y: violations.rule2_below.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-2: Below CL',
                    marker: { color: 'orange', size: 11, symbol: 'circle' },
                    text: violations.rule2_below.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
        }

        if (settings.rule_3_b) {
            if (violations.rule3_increasing.length > 0) {
                traces.push({
                    x: violations.rule3_increasing.map(i => xRange[i]),
                    y: violations.rule3_increasing.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-3: Increasing',
                    marker: { color: 'rosybrown', size: 9, symbol: 'circle' },
                    text: violations.rule3_increasing.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
            if (violations.rule3_decreasing.length > 0) {
                traces.push({
                    x: violations.rule3_decreasing.map(i => xRange[i]),
                    y: violations.rule3_decreasing.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-3: Decreasing',
                    marker: { color: 'rosybrown', size: 9, symbol: 'circle' },
                    text: violations.rule3_decreasing.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
        }

        if (settings.rule_4_b) {
            if (violations.rule4_alternating.length > 0) {
                traces.push({
                    x: violations.rule4_alternating.map(i => xRange[i]),
                    y: violations.rule4_alternating.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-4: Alternating',
                    marker: { color: 'indianred', size: 9, symbol: 'circle' },
                    text: violations.rule4_alternating.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
        }

        if (settings.rule_5_b) {
            if (violations.rule5_above.length > 0) {
                traces.push({
                    x: violations.rule5_above.map(i => xRange[i]),
                    y: violations.rule5_above.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-5: Above 2σ',
                    marker: { color: 'darkviolet', size: 9, symbol: 'circle' },
                    text: violations.rule5_above.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
            if (violations.rule5_below.length > 0) {
                traces.push({
                    x: violations.rule5_below.map(i => xRange[i]),
                    y: violations.rule5_below.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-5: Below 2σ',
                    marker: { color: 'darkviolet', size: 9, symbol: 'circle' },
                    text: violations.rule5_below.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
        }

        if (settings.rule_6_b) {
            if (violations.rule6_above.length > 0) {
                traces.push({
                    x: violations.rule6_above.map(i => xRange[i]),
                    y: violations.rule6_above.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-6: Above 1σ',
                    marker: { color: 'violet', size: 9, symbol: 'circle' },
                    text: violations.rule6_above.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
            if (violations.rule6_below.length > 0) {
                traces.push({
                    x: violations.rule6_below.map(i => xRange[i]),
                    y: violations.rule6_below.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-6: Below 1σ',
                    marker: { color: 'violet', size: 9, symbol: 'circle' },
                    text: violations.rule6_below.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
        }

        if (settings.rule_7_b) {
            if (violations.rule7_within.length > 0) {
                traces.push({
                    x: violations.rule7_within.map(i => xRange[i]),
                    y: violations.rule7_within.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-7: Within 1σ',
                    marker: { color: 'yellowgreen', size: 9, symbol: 'circle' },
                    text: violations.rule7_within.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
        }

        if (settings.rule_8_b) {
            if (violations.rule8_outside.length > 0) {
                traces.push({
                    x: violations.rule8_outside.map(i => xRange[i]),
                    y: violations.rule8_outside.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-8: Outside 1σ',
                    marker: { color: 'darkgreen', size: 9, symbol: 'circle' },
                    text: violations.rule8_outside.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
        }

        // Annotations
        const annotations = [
            {
                x: xRange[xRange.length - 1],
                y: controllines.i_cl,
                text: `CL=${controllines.i_cl.toFixed(legend_decimal)}`,
                arrowhead: 1, arrowwidth: 1, arrowcolor: "#636363",
                ax: 55,
                ay: 0,
                font: { size: 10, color: 'black', family: 'Courier New, monospace' },
                align: 'right'
            }
        ];
        
        if (settings.show_3sl_upper) {
            annotations.push({
                x: xRange[xRange.length - 1],
                y: controllines.i_ucl,
                text: `UCL=${controllines.i_ucl.toFixed(legend_decimal)}`,
                showarrow: true,
                arrowhead: 1, arrowsize: 1, arrowwidth: 1, arrowcolor: "#636363",
                ax: 50,
                ay: -10,
                font: { size: 10, color: 'black', family: 'Courier New, monospace' },
                align: 'right'
            });
        }
        
        if (settings.show_3sl_lower) {
            annotations.push({
                x: xRange[xRange.length - 1],
                y: controllines.i_lcl,
                text: `LCL=${controllines.i_lcl.toFixed(legend_decimal)}`,
                showarrow: true,
                arrowhead: 1, arrowwidth: 1, arrowcolor: "#636363",
                ax: 50,
                ay: 10,
                font: { size: 10, color: 'black', family: 'Courier New, monospace' },
                align: 'right'
            });
        }
        
        if (settings.show_2sl_upper) {
            annotations.push({
                x: xRange[xRange.length - 1],
                y: controllines.i_2su,
                text: `U2sL=${controllines.i_2su.toFixed(legend_decimal)}`,
                showarrow: true,
                arrowhead: 1, arrowwidth: 1, arrowcolor: "#636363",
                ax: 50,
                ay: -5,
                font: { size: 10, color: 'black', family: 'Courier New, monospace' }
            });
        }
        
        if (settings.show_2sl_lower) {
            annotations.push({
                x: xRange[xRange.length - 1],
                y: controllines.i_2sl,
                text: `L2sL=${controllines.i_2sl.toFixed(legend_decimal)}`,
                showarrow: true,
                arrowhead: 1, arrowwidth: 1, arrowcolor: "#636363",
                ax: 50,
                ay: 5,
                font: { size: 10, color: 'black', family: 'Courier New, monospace' }
            });
        }
        
        if (settings.show_usl && controllines.usl !== null) {
            annotations.push({
                x: xRange[xRange.length - 1],
                y: controllines.usl,
                text: `USL=${controllines.usl.toFixed(legend_decimal)}`,
                showarrow: true,
                arrowhead: 1, arrowwidth: 1, arrowcolor: "#636363",
                ax: 50,
                ay: -15,
                font: { size: 10, color: 'black', family: 'Courier New, monospace' }
            });
        }
        
        if (settings.show_lsl && controllines.lsl !== null) {
            annotations.push({
                x: xRange[xRange.length - 1],
                y: controllines.lsl,
                text: `LSL=${controllines.lsl.toFixed(legend_decimal)}`,
                showarrow: true,
                arrowhead: 1, arrowwidth: 1, arrowcolor: "#636363",
                ax: 50,
                ay: 15,
                font: { size: 10, color: 'black', family: 'Courier New, monospace' }
            });
        }

        // Adjust x-axis ticks
        let tickvals = xRange;
        let ticktext = timeStamps;
        if (data.length > 31) {
            const interval = Math.ceil(data.length / 30);
            tickvals = xRange.filter((_, i) => i % interval === 0);
            ticktext = timeStamps.filter((_, i) => i % interval === 0);
        }

        // Layout
        const layout = {
            title: { text: i_graph_title, y: 0.95, x: 0.5, xanchor: 'center', font: { size: 15 } },
            margin: { l: 30, r: 30, b: 30, t: 60 },
            xaxis: {
                tickangle: 45,
                tickmode: 'array',
                tickvals: tickvals,
                ticktext: ticktext,
                automargin: true,
                showline: true,
                linewidth: 1,
                linecolor: 'black',
                mirror: false,
                ticks: 'outside',
                gridcolor: 'rgba(0,0,0,0)',
                tickfont: { size: 10 },
                zeroline: false,
                autorange: true
            },
            yaxis: {
                title: { text: yaxis_title, x: 0.5 },
                automargin: true,
                showline: true,
                linewidth: 1,
                linecolor: 'black',
                mirror: false,
                gridcolor: 'rgba(0,0,0,0)',
                zeroline: false,
                autorange: true,
                ticks: 'outside',
                tickfont: { size: 8.5 },
            },
            annotations: annotations,
            legend: { orientation: 'v', x: 1.03, y: 1, xanchor: 'left', yanchor: 'top', bgcolor: 'rgba(255, 255, 255, 0.8)' },
            plot_bgcolor: 'rgba(0,0,0,0)',
            hovermode: 'closest',
            shapes: [
                {
                    type: 'rect',
                    x0: 0,
                    y0: 0,
                    x1: 1,
                    y1: 1,
                    xref: 'paper',
                    yref: 'paper',
                    line: { color: 'black', width: 1 },
                    fillcolor: 'rgba(0,0,0,0)'
                }
            ],
            showlegend: true,
        };

        // Plot
        Plotly.newPlot('chartIDiv', traces, layout, {
            displaylogo: false,
            modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'resetScale2d', 'zoomOut2d', 'zoomIn2d', 'zoom2d']
        }).then(() => {
            attachIChartClickHandler(); // ✅ CORRECT PLACE
        });

    }

    
    function plotMRChart(data, controllines, settings, violations) {
        if (data.length <= 3 || !controllines || !controllines.mr_cl) {
            $('#chartMRDiv').html('Not enough data or invalid control lines for MR chart');
            return;
        }
        // Reverse data to plot from oldest to newest
        data = data.reverse();
        const xRange = Array.from({ length: data.length }, (_, i) => i + 1);
        const timeStamps = data.map(d => d.time_stamp);
        const dataPoints = data.map(d => d.mr);
        const legend_decimal = settings.legend_decimals;

        // Initialize traces
        const traces = [
            {
                x: xRange,
                y: dataPoints,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Moving Range',
                line: { color: 'cornflowerblue', width: 1 },
                marker: { size: 7 },
                opacity: 0.8,
                text: timeStamps,
                hovertemplate: '%{y}, %{text}'
            },
            {
                x: xRange,
                y: Array(xRange.length).fill(controllines.mr_cl),
                type: 'scatter',
                mode: 'lines',
                name: 'CL',
                line: { dash: 'dash', color: 'black', shape: 'hvh' },
                opacity: 0.8,
                showlegend: false
            }
        ];

        // Add control lines based on settings
        if (settings.show_3sl_upper) {
            traces.push({
                x: xRange,
                y: Array(xRange.length).fill(controllines.mr_ucl),
                type: 'scatter',
                mode: 'lines',
                name: 'UCL',
                line: { color: 'red', shape: 'hvh' },
                opacity: 0.8,
                showlegend: false
            });
        }
        
        if (settings.show_3sl_lower) {
            traces.push({
                x: xRange,
                y: Array(xRange.length).fill(controllines.mr_lcl),
                type: 'scatter',
                mode: 'lines',
                name: 'LCL',
                line: { color: 'red', shape: 'hvh' },
                opacity: 0.8,
                showlegend: false
            });
        }

        // Add SPC Rule violation traces
        if (settings.r_s_rule_1_b) {
            if (violations.rule1_above.length > 0) {
                traces.push({
                    x: violations.rule1_above.map(i => xRange[i]),
                    y: violations.rule1_above.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-1: Above UCL',
                    marker: { color: 'darkred', size: 9, symbol: 'circle' },
                    text: violations.rule1_above.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
            if (violations.rule1_below.length > 0) {
                traces.push({
                    x: violations.rule1_below.map(i => xRange[i]),
                    y: violations.rule1_below.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-1: Below LCL',
                    marker: { color: 'darkred', size: 9, symbol: 'circle' },
                    text: violations.rule1_below.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
        }

        if (settings.r_s_rule_2_b) {
            if (violations.rule2_above.length > 0) {
                traces.push({
                    x: violations.rule2_above.map(i => xRange[i]),
                    y: violations.rule2_above.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-2: Above CL',
                    marker: { color: 'orange', size: 11, symbol: 'circle' },
                    text: violations.rule2_above.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
            if (violations.rule2_below.length > 0) {
                traces.push({
                    x: violations.rule2_below.map(i => xRange[i]),
                    y: violations.rule2_below.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-2: Below CL',
                    marker: { color: 'orange', size: 11, symbol: 'circle' },
                    text: violations.rule2_below.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
        }

        if (settings.r_s_rule_3_b) {
            if (violations.rule3_increasing.length > 0) {
                traces.push({
                    x: violations.rule3_increasing.map(i => xRange[i]),
                    y: violations.rule3_increasing.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-3: Increasing',
                    marker: { color: 'rosybrown', size: 9, symbol: 'circle' },
                    text: violations.rule3_increasing.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
            if (violations.rule3_decreasing.length > 0) {
                traces.push({
                    x: violations.rule3_decreasing.map(i => xRange[i]),
                    y: violations.rule3_decreasing.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-3: Decreasing',
                    marker: { color: 'rosybrown', size: 9, symbol: 'circle' },
                    text: violations.rule3_decreasing.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
        }

        if (settings.r_s_rule_4_b) {
            if (violations.rule4_alternating.length > 0) {
                traces.push({
                    x: violations.rule4_alternating.map(i => xRange[i]),
                    y: violations.rule4_alternating.map(i => dataPoints[i]),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Rule-4: Alternating',
                    marker: { color: 'indianred', size: 9, symbol: 'circle' },
                    text: violations.rule4_alternating.map(i => timeStamps[i]),
                    hovertemplate: '%{y}, %{text}'
                });
            }
        }

        // Annotations
        const annotations = [
            {
                x: xRange[xRange.length - 1],
                y: controllines.mr_cl,
                text: `CL=${controllines.mr_cl.toFixed(legend_decimal)}`,
                arrowhead: 1, arrowwidth: 1, arrowcolor: "#636363",
                ax: 55,
                ay: 0,
                font: { size: 10, color: 'black', family: 'Courier New, monospace' },
                align: 'right'
            }
        ];
        if (settings.show_3sl_upper) {
            annotations.push({
                x: xRange[xRange.length - 1],
                y: controllines.mr_ucl,
                text: `UCL=${controllines.mr_ucl.toFixed(legend_decimal)}`,
                showarrow: true,
                arrowhead: 1, arrowsize: 1, arrowwidth: 1, arrowcolor: "#636363",
                ax: 50,
                ay: -10,
                font: { size: 10, color: 'black', family: 'Courier New, monospace' },
                align: 'right'
            });
        }
        
        if (settings.show_3sl_lower) {
            annotations.push({
                x: xRange[xRange.length - 1],
                y: controllines.mr_lcl,
                text: `LCL=${controllines.mr_lcl.toFixed(legend_decimal)}`,
                showarrow: true,
                arrowhead: 1, arrowwidth: 1, arrowcolor: "#636363",
                ax: 50,
                ay: 10,
                font: { size: 10, color: 'black', family: 'Courier New, monospace' },
                align: 'right'
            });
        }

        // Adjust x-axis ticks
        let tickvals = xRange;
        let ticktext = timeStamps;
        if (data.length > 30) {
            const interval = Math.ceil(data.length / 30);
            tickvals = xRange.filter((_, i) => i % interval === 0);
            ticktext = timeStamps.filter((_, i) => i % interval === 0);
        }

        // Layout
        const layout = {
            title: { text: mr_graph_title, y: 0.95, x: 0.5, xanchor: 'center', font: { size: 15 } },
            margin: { l: 30, r: 30, b: 30, t: 60 },
            xaxis: {
                tickangle: 45,
                tickmode: 'array',
                tickvals: tickvals,
                ticktext: ticktext,
                automargin: true,
                showline: true,
                linewidth: 1,
                linecolor: 'black',
                mirror: false,
                ticks: 'outside',
                gridcolor: 'rgba(0,0,0,0)',
                tickfont: { size: 10 },
                zeroline: false,
                autorange: true
            },
            yaxis: {
                title: { text: 'Moving Range', x: 0.5 },
                automargin: true,
                showline: true,
                linewidth: 1,
                linecolor: 'black',
                mirror: false,
                gridcolor: 'rgba(0,0,0,0)',
                zeroline: false,
                autorange: true,
                ticks: 'outside',
                tickfont: { size: 8.5 },
            },
            annotations: annotations,
            legend: { orientation: 'v', x: 1.03, y: 1, xanchor: 'left', yanchor: 'top', bgcolor: 'rgba(255, 255, 255, 0.8)' },
            plot_bgcolor: 'rgba(0,0,0,0)',
            hovermode: 'closest',
            shapes: [
                {
                    type: 'rect',
                    x0: 0,
                    y0: 0,
                    x1: 1,
                    y1: 1,
                    xref: 'paper',
                    yref: 'paper',
                    line: { color: 'black', width: 1 },
                    fillcolor: 'rgba(0,0,0,0)'
                }
            ],
            showlegend: true,
        };

        // Plot
        Plotly.newPlot('chartMRDiv', traces, layout, {
            displaylogo: false,
            modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'resetScale2d', 'zoomOut2d', 'zoomIn2d', 'zoom2d']
        });
    }

    
    function displayRawData(rawData,relevant_choice_keys,relevant_text_keys) {
        let timezone = "{{ work_unit_timezone | safe}}"
        const datetime = 'Sample Time('.concat(timezone,')')
        const updationtime = 'Updated('.concat(timezone,')')
        const relevantChoiceKeys = relevant_choice_keys || [];
        const relevantTextKeys = relevant_text_keys || [];

        const columnDefs = [
            {headerName: 'Edit', field: 'Edit', width: 80,maxWidth: 100, floatingFilter:false,
                cellRenderer: function (params) {
                    if (params.value) {
                        const div = document.createElement('div');
                        div.innerHTML = params.value;
                        return div.firstElementChild.outerHTML;
                    }
                    return '';
                    },},
                
                {headerName: datetime, field: 'time_stamp'},
                {headerName: updationtime, field: 'updation_time'},
                {headerName: 'Measurement', field: 'data_point'},
                {headerName: 'Batch/Lot', field: 'lot_no'},
                {headerName: 'Sample Id', field: 'sample_id'},
                {headerName: 'Operator', field: 'operator'},
                {headerName: 'Gauge', field: 'gauge'},
                {headerName: 'Inspector', field: 'inspector'},
                {headerName: 'Remarks', field: 'remarks'},
                {headerName: 'Cause', field: 'causes'},
                // {headerName: 'Id', field: 'id'},
        ];
        // Dynamically add choice fields to column definitions
        relevantChoiceKeys.forEach(key => {
            columnDefs.push({ headerName: key, field: key });
        });

        relevantTextKeys.forEach(key => {
            columnDefs.push({ headerName: key, field: key });
        });


        const gridOptions = {
            onGridReady:function(params){
                       params.columnApi.autoSizeAllColumns();
            },
            columnDefs: columnDefs,
            rowData: rawData,
            // defaultColDef: { sortable: true, filter: true }
            defaultColDef:{
                editable: false,
                filter: true,
                // flex:1,
                // maxWidth: 180,
                resizable: true,
                wrapText:false,
                autoHeight:false,
                sortable:true,
                floatingFilter: true,
                filter: 'agMultiColumnFilter',
            },
            enableRangeSelection:true,
            suppressLastEmptyLineOnPaste:true,

        };

        const gridDiv = document.querySelector('#gridDiv');
        
        if (gridDiv.children.length > 0) {
            gridDiv.innerHTML = '';
        }
        new agGrid.Grid(gridDiv, gridOptions);
        $('#gridDiv').show();
    }


    function setRefreshInterval() {
        var minutes = parseFloat($('#refresh_rate').val());
        // Clamp the value between 0.5 and 30
        if (minutes < 0.5) {
            minutes = 0.5;
            $('#refresh_rate').val(minutes); // update the input field
        } else if (minutes > 30) {
            minutes = 30;
            $('#refresh_rate').val(minutes); // update the input field
        }
        if (minutes > 0) {
            var interval = minutes * 60 * 1000;
            if (intervalId) {
                clearInterval(intervalId);
            }
            intervalId = setInterval(fetchData, interval);
        } else if (intervalId) {
            clearInterval(intervalId);
        }
    }

    let currentRecordId = null; // Store the clicked record ID globally
    const links = {{ links|safe }}; // Ensure links array is passed correctly
    let allCauses = {{ all_causes | safe }};

            
    // Fetch record details and manage modals
    function fetchRecordDetails(recordId) {
        var getRecordDetailsUrl = "{% url 'app1:imr_record_details' 999999 %}".replace("999999/", "");
        return fetch(`${getRecordDetailsUrl}${recordId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateModalTable(data.record);
                    document.getElementById("descriptionModal").style.display = "block"; // Open descriptionModal
                    document.getElementById("rootCauseModal").style.display = "none";    // Ensure rootCauseModal is closed
                } else {
                    alert("Record not found!");
                }
            })
            .catch(error => console.error("Error fetching record:", error));
    }

    // Populate the descriptionModal table with record data
    function populateModalTable(record) {
        var tableBody = document.getElementById("recordTableBody");
        tableBody.innerHTML = ""; // Clear previous data
        for (const [key, value] of Object.entries(record)) {
            if (key === "choice_keys" && Array.isArray(value)) {
                value.forEach(item => {
                    let row = document.createElement("tr");
                    row.innerHTML = `<td>${item.key}</td><td>${item.value}</td>`;
                    tableBody.appendChild(row);
                });
            } else if (key === "text_keys" && Array.isArray(value)) {
                value.forEach(item => {
                    let row = document.createElement("tr");
                    row.innerHTML = `<td>${item.key}</td><td>${item.value}</td>`;
                    tableBody.appendChild(row);
                });
            } else if (key === "cause_data" && Array.isArray(value)) {
                value.forEach((item, index) => {
                    let causeRow = document.createElement("tr");
                    causeRow.innerHTML = `<td>Cause ${index + 1}</td><td>${item.cause_name}</td>`;
                    tableBody.appendChild(causeRow);
                    if (item.cause_description && item.cause_description.trim() !== "") {
                        let descRow = document.createElement("tr");
                        descRow.innerHTML = `<td>Description ${index + 1}</td><td>${item.cause_description}</td>`;
                        tableBody.appendChild(descRow);
                    }
                });
            } else {
                let row = document.createElement("tr");
                let formattedKey = key.replace(/_/g, " ");
                formattedKey = formattedKey.charAt(0).toUpperCase() + formattedKey.slice(1).toLowerCase();
                row.innerHTML = `<td>${formattedKey}</td><td>${value !== null ? value : "N/A"}</td>`;
                tableBody.appendChild(row);
            }
        }
    }
    
    function addRootCause(){
        const RULE_CHOICES = [['1', '1'], ['2', '2'], ['3', '3'], ['4', '4'], ['5', '5'], ['6', '6'], ['7', '7'], ['8', '8'], ['no_rule', 'no_rule']];
        const descriptionModal = document.getElementById("descriptionModal");
        const rootCauseModal = document.getElementById("rootCauseModal");
        const rootCauseForm = document.getElementById("rootCauseForm");
        const ruleSelect = document.getElementById("rule");
        const causeSelect = document.getElementById("cause");

        ruleSelect.innerHTML = "";
        RULE_CHOICES.forEach(([value, label]) => {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = label;
            if (value === "no_rule") option.selected = true;
            ruleSelect.appendChild(option);
        });

        causeSelect.innerHTML = "";
        allCauses.forEach(cause => {
            const option = document.createElement("option");
            option.value = cause;
            option.textContent = cause;
            causeSelect.appendChild(option);
        });

        if (!currentRecordId) {
            alert("No record selected!");
            return;
        }

        document.getElementById("rootCauseRecordId").value = currentRecordId;
        rootCauseModal.style.display = "block";

        rootCauseForm.onsubmit = function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            let baseUrl = "{% url 'app1:add_root_cause' 0 %}";
            let cause_url = baseUrl.replace("/0/", `/${currentRecordId}/`);

            fetch(cause_url, {
                method: "POST",
                body: formData,
                headers: { "X-CSRFToken": "{{ csrf_token }}" }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Root Cause Added!");
                    rootCauseForm.reset();
                    rootCauseModal.style.display = "none";
                    //descriptionModal.style.display = "none";
                    fetchRecordDetails(currentRecordId).then(() => {
                        descriptionModal.style.display = "block";
                    }).catch(err => {
                        console.error("Failed to refresh data:", err);
                        alert("Failed to refresh data, please try again.");
                    });
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(err => console.error("Error:", err));
        };

        closeRootCauseModal.onclick = function () {
            rootCauseModal.style.display = "none";
        };
    }

    // Handle for Edit Data point Modal
    function openEditDataPoint() {
        const modal = document.getElementById('editDataPointModal');
        modal.style.display = 'block';

        let baseUrl = "{% url 'app1:record_imr_individual_data_details' 0 %}";
        let edit_data_url = baseUrl.replace("/0/", `/${currentRecordId}/`);

        fetch(edit_data_url)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch record data');
                return response.json();
            })
            .then(data => {
                populateEditForm(data);
                document.getElementById('editRecordId').value = currentRecordId;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Unable to load data for editing');
            });

        // Close button functionality
        document.getElementById('closeEditModal').onclick = function () {
            modal.style.display = 'none';
        };
    }

    document.addEventListener('DOMContentLoaded', function () {
        var descriptionModal = document.getElementById("descriptionModal");
        var rootCauseModal = document.getElementById("rootCauseModal");
        var closeModal = document.getElementById("closeModal");
        var closeRootCauseModal = document.getElementById("closeRootCauseModal");

        closeModal.onclick = function () {
            descriptionModal.style.display = "none";
        };

        window.onclick = function (event) {
            if (event.target === descriptionModal) descriptionModal.style.display = "none";
            if (event.target === rootCauseModal) rootCauseModal.style.display = "none";
        };

        const editDataPointForm = document.getElementById('editDataPointForm');
        if (editDataPointForm) {
            editDataPointForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const saveButton = this.querySelector('button[type="submit"]');
                if (saveButton.disabled) return;
    
                saveButton.disabled = true;
                const formData = new FormData(this);
                const data = { causes: [] };
    
                // Collect main fields, choices, and texts
                formData.forEach((value, key) => {
                    if (!key.startsWith('cause_')) {
                        data[key] = value;
                    }
                });
    
                // Collect causes
                const causes = {};
                formData.forEach((value, key) => {
                    if (key.startsWith('cause_')) {
                        const [prefix, field, id] = key.split('_');
                        if (!causes[id]) causes[id] = { id: id };
                        if (field === 'rule') causes[id].rule = value;
                        else if (field === 'cause') causes[id].cause_id = value;
                        else if (field === 'notes') causes[id].notes = value;
                    }
                });
                data.causes = Object.values(causes);
    
                let baseUrl = "{% url 'app1:update_record' 0 %}";
                let update_data_url = baseUrl.replace("/0/", `/${currentRecordId}/`);
    
                fetch(update_data_url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    saveButton.disabled = false;
                    if (result.success) {
                        alert('Record updated successfully');
                        document.getElementById('editDataPointModal').style.display = 'none';
                        fetchRecordDetails(currentRecordId).then(() => {
                            document.getElementById("descriptionModal").style.display = "block";
                        }).catch(err => {
                            console.error("Failed to refresh data:", err);
                            alert("Failed to refresh data, please try again.");
                        });
                    } else {
                        alert('Error: ' + result.error);
                    }
                })
                .catch(error => {
                    saveButton.disabled = false;
                    console.error('Error:', error);
                    alert('Failed to update record');
                });
            }, { once: false });
        }
    });

    function populateEditForm(data) {
        const mainFieldsDiv = document.getElementById('mainFields');
        const choiceFieldsDiv = document.getElementById('choiceFields');
        const textFieldsDiv = document.getElementById('textFields');
        const causeFieldsDiv = document.getElementById('causeFields');
    
        // Clear all divs
        mainFieldsDiv.innerHTML = '';
        choiceFieldsDiv.innerHTML = '';
        textFieldsDiv.innerHTML = '';
        causeFieldsDiv.innerHTML = '';
    
        // Create a single table in mainFieldsDiv
        const table = document.createElement('table');
        table.className = 'edit-table'; // Class for styling
        const tbody = document.createElement('tbody');
    
        // **Main Fields Section**
        const mainHeaderRow = document.createElement('tr');
        tbody.appendChild(mainHeaderRow);
    
        const mainFields = [
            { name: 'time_stamp', label: 'Time stamp', type: 'datetime-local' },
            { name: 'lot_no', label: 'Lot no', type: 'text' },
            { name: 'serial_no', label: 'Serial no', type: 'text' },
            { name: 'remarks', label: 'Remarks', type: 'textarea' },
            { name: 'data_point', label: 'Data point', type: 'number', step: 'any', min: 0 },
            { name: 'sample_id', label: 'Sample id', type: 'number' },
        ];
    
        mainFields.forEach(field => {
            const row = document.createElement('tr');
            const labelCell = document.createElement('td');
            labelCell.textContent = field.label;
            const inputCell = document.createElement('td');
            let input;
            if (field.type === 'textarea') {
                input = document.createElement('textarea');
                input.name = field.name;
                input.value = data.main[field.name] || '';
                input.rows = 3;
                input.cols = 20;
            } else {
                input = document.createElement('input');
                input.type = field.type;
                input.name = field.name;
                if (field.name === 'time_stamp' && data.main[field.name]) {
                    const dateObj = new Date(data.main[field.name]);
                    const tzOffset = -dateObj.getTimezoneOffset();
                    const localDate = new Date(dateObj.getTime() + tzOffset * 60 * 1000);
                    input.value = localDate.toISOString().slice(0, 19);
                    input.step = 1;
                } else {
                    input.value = data.main[field.name] || '';
                }
                if (field.step) input.step = field.step;
                if (field.min !== undefined) input.min = field.min;
            }
            inputCell.appendChild(input);
            row.appendChild(labelCell);
            row.appendChild(inputCell);
            tbody.appendChild(row);
        });
    
        // Additional Main Fields (Operator, Inspector, Gauge)
        const additionalFields = [
            { label: 'Operator', name: 'operator', options: data.operators, selectedId: data.main.operator_id },
            { label: 'Inspector', name: 'inspector', options: data.inspectors, selectedId: data.main.inspector_id },
            { label: 'Gauge', name: 'gauge', options: data.gauges, selectedId: data.main.gauge_id }
        ];
    
        additionalFields.forEach(field => {
            const row = document.createElement('tr');
            const labelCell = document.createElement('td');
            labelCell.textContent = field.label;
            const selectCell = document.createElement('td');
            const select = document.createElement('select');
            select.name = field.name;
            select.innerHTML = '<option value="">----</option>' + 
                field.options.map(opt => 
                    `<option value="${opt.id}" ${opt.id === field.selectedId ? 'selected' : ''}>${opt.name}</option>`
                ).join('');
            selectCell.appendChild(select);
            row.appendChild(labelCell);
            row.appendChild(selectCell);
            tbody.appendChild(row);
        });
    
        // **Choice Fields Section**
        if (data.choices.length > 0) {
            const choiceHeaderRow = document.createElement('tr');
            tbody.appendChild(choiceHeaderRow);
    
            data.choices.forEach(choice => {
                const row = document.createElement('tr');
                const labelCell = document.createElement('td');
                labelCell.textContent = choice.choice_key;
                const selectCell = document.createElement('td');
                const select = document.createElement('select');
                select.name = `choice_${choice.choice_key}`;
                const options = data.all_choice_values[choice.choice_key].map(val => 
                    `<option value="${val.id}" ${val.id === choice.choice_id ? 'selected' : ''}>${val.name}</option>`
                ).join('');
                select.innerHTML = `<option value="">----</option>${options}`;
                selectCell.appendChild(select);
                row.appendChild(labelCell);
                row.appendChild(selectCell);
                tbody.appendChild(row);
            });
        }
    
        // **Text Fields Section**
        if (data.texts.length > 0) {
            const textHeaderRow = document.createElement('tr');
            tbody.appendChild(textHeaderRow);
    
            data.texts.forEach(text => {
                const row = document.createElement('tr');
                const labelCell = document.createElement('td');
                labelCell.textContent = text.key_name;
                const inputCell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'text';
                input.name = `text_${text.id}`;
                input.value = text.value || '';
                inputCell.appendChild(input);
                row.appendChild(labelCell);
                row.appendChild(inputCell);
                tbody.appendChild(row);
            });
        }
    
        // **Cause Fields Section**
        if (data.causes.length > 0) {
            data.causes.forEach((cause, index) => {
                // Cause Header
                const causeHeaderRow = document.createElement('tr');
                // Rule Row
                const ruleRow = document.createElement('tr');
                const ruleLabelCell = document.createElement('td');
                ruleLabelCell.textContent = 'Rule:';
                const ruleInputCell = document.createElement('td');
                const ruleSelect = document.createElement('select');
                ruleSelect.name = `cause_rule_${cause.id}`;
                const ruleOptions = ['1', '2', '3', '4', '5', '6', '7', '8', 'no_rule'];
                ruleSelect.innerHTML = ruleOptions.map(option =>
                    `<option value="${option}" ${option === cause.rule ? 'selected' : ''}>${option}</option>`
                ).join('');
                ruleInputCell.appendChild(ruleSelect);
                ruleRow.appendChild(ruleLabelCell);
                ruleRow.appendChild(ruleInputCell);
                tbody.appendChild(ruleRow);
    
                // Cause Row
                const causeRow = document.createElement('tr');
                const causeLabelCell = document.createElement('td');
                causeLabelCell.textContent = 'Cause:';
                const causeInputCell = document.createElement('td');
                const causeSelect = document.createElement('select');
                causeSelect.name = `cause_cause_${cause.id}`;
                causeSelect.innerHTML = data.all_causes.map(val =>
                    `<option value="${val.id}" ${val.id === cause.cause_id ? 'selected' : ''}>${val.name}</option>`
                ).join('');
                causeInputCell.appendChild(causeSelect);
                causeRow.appendChild(causeLabelCell);
                causeRow.appendChild(causeInputCell);
                tbody.appendChild(causeRow);
    
                // Notes Row
                const notesRow = document.createElement('tr');
                const notesLabelCell = document.createElement('td');
                notesLabelCell.textContent = 'Notes:';
                const notesInputCell = document.createElement('td');
                const notesTextarea = document.createElement('textarea');
                notesTextarea.name = `cause_notes_${cause.id}`;
                notesTextarea.value = cause.notes || '';
                notesTextarea.rows = 3;
                notesTextarea.cols = 40;
                notesInputCell.appendChild(notesTextarea);
                notesRow.appendChild(notesLabelCell);
                notesRow.appendChild(notesInputCell);
                tbody.appendChild(notesRow);
            });
        }
    
        table.appendChild(tbody);
        mainFieldsDiv.appendChild(table);
    }



    $('#refresh_rate').change(function() {
        setRefreshInterval();
    });

    $('#historical_mu').change(function() {
        fetchData();
    });
    
    $('#historical_sigma').change(function() {
        fetchData();
    });

    $('#display_raw_data').change(function() {
        fetchData();
    });

    $('#display_mr_chart').change(function() {
        fetchData();
    });

    $('#hide_sidebar').change(function() {
        $('.r-box').toggle(!$(this).is(':checked'));
    });

    $('#last_n_records').change(function() {
        var value = parseInt($(this).val(), 10); // check base int val

        if (isNaN(value) || value < 5 || value > 3000) {
            alert("Please enter a value between 5 and 3000.");
            $(this).val(31); // reset to default
            return; // stop execution
        }

        fetchData();
    });
    // Initial setup
    fetchData();
    setRefreshInterval();
</script>

<!-- Add Record Modal -->
<div id="descriptionModal" class="modal" style="width: 28%; height: 45vh; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; border: 2px solid black; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5); z-index: 1000; display: none; overflow-y: auto;">
    <span id="closeModal" style="position: absolute; top: -5px; right: 5px; cursor: pointer; font-size: 30px; font-weight: bold; color: red; z-index: 1001;">&times;</span>
    <div class="modal-content" style="padding: 20px; position: relative; height: 100%; display: flex; flex-direction: column;">
        <div class="modal-body" style="justify-content: center; overflow-y: auto; max-height: 90vh; padding-right: 10px;">
            <table id="recordTable">
                <tbody id="recordTableBody"></tbody>
            </table>
        </div>
        <div class="modal-footer" style="margin-top: 15px;text-align: left;width: 100%;display: flex;justify-content: flex-start;align-items: center;height: 30px; /* Adjust as needed */padding: 5px 0; /* Reduce vertical padding */">
            {% if perms.app1.add_recordimrindividualdata%}
            <button type="button" class="r-button" onclick="addRootCause()">
                <img src="{{ add_icon_url }}" > Root cause
            </button>
            {% endif %}

            {% if perms.app1.change_recordimrindividualdata%}
            <button type="button" class="r-button" onclick="openEditDataPoint()"  style="width: 100px;">Edit</button>
            {% endif %}
        </div>
    </div>
</div>  

<!-- Edit Data Point Modal -->
<div id="editDataPointModal" class="modal" 
    style="width: 28%; height: 49vh; position: fixed; top: 45%; left: 55%; transform: translate(-50%, -50%); background-color: white; border: 2px solid black; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5); z-index: 1000; display: none; overflow-y:auto; overflow-x: auto;">
    <span id="closeEditModal" style="position: absolute; top: -10px; right: 17px; cursor: pointer; font-size: 30px; font-weight: bold; color: red;">×</span>
    <h2 style="text-align: center; margin-top: 10px;">Edit Data Point</h2>
    <form id="editDataPointForm" style="padding: 10px; max-height: 80%; overflow-y:auto; overflow-x: auto; ">
        <input type="hidden" name="record_id" id="editRecordId">
        <!-- Main Fields Container -->
        <div id="mainFields"></div>
        <!-- Choice Fields Container -->
        <div id="choiceFields"></div>
        <!-- Text Fields Container -->
        <div id="textFields"></div>
        <!-- Cause Fields Container -->
        <div id="causeFields"></div>
        <div style="text-align: left;">
            <button type="submit" class="r-button"  style="width: 100px;">Save</button>
        </div>
    </form>
</div>

<!-- Add Root Cause Modal -->
<div id="rootCauseModal" class="modal"
    style="width: 28%; height: 49vh; position: fixed; top: 45%; left: 55%; transform: translate(-50%, -50%); background-color: white; border: 2px solid black; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5); z-index: 1000; display: none; overflow-y: auto; overflow-x: auto;">
    <span id="closeRootCauseModal" style="position: absolute; top: 10px; right: 20px; cursor: pointer; font-size: 30px; font-weight: bold; color: red;">×</span>
    <h2 style="text-align: center; margin-top: 10px;">Add Root Cause</h2>
    <form id="rootCauseForm" style="padding-left: 20px; white-space: nowrap; margin-top: 10px; overflow-y: auto; overflow-x: auto; ">
        <input type="hidden" name="record_id" id="rootCauseRecordId">
        
        <label for="rule">Rule:</label>
        <select name="rule" id="rule" required></select><br><br>
        
        <label for="cause"><b>Cause:</b></label>
        <select name="cause" id="cause" required></select><br><br>
        
        <label for="notes">Notes:</label><br>
        <textarea name="notes" id="notes" rows="4" cols="40"></textarea><br><br>
        
        <div style="text-align: left;" >
            <button type="submit" class="r-button"  style="width: 100px;">Save</button>
        </div>
    </form>
</div>

<style>
    .error-message {
        color: red;
        font-weight: bold;
        display: block;
        text-align: center;
        font-size: 1.25em; /* Equivalent to h1 */
    }
</style>
{% endblock content %}