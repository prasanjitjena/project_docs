{% extends "admin/base.html" %}
{% block extrahead %}
{% load static %}
<script src="{% static 'plotly/plotly-2.27.0.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/all.min.css' %}"/> 
<script src="{% static 'agrid/30.0.6_dist_ag-grid-enterprise.js' %}"></script> 
<title>Data Entry Defective</title>

{% endblock extrahead %}
{% block content_title %}{% endblock %}
{% block content %}
<div class="container-fluid1">
    <div class="row">
        <div class="{% if hide_right_sidebar %} col-md-12 {% else %} col-md-9 {% endif %}">
            <div class="row">
                <div class="col-md-12">
                    <table class="table table-bordered table-sm table-hover">
                        <thead class="toptable">
                            <tr>
                                <th class="toptable">
                                    S#
                                </th>
                                <th class="toptable">
                                    Equipment
                                </th>
                                <th class="toptable">
                                    Part
                                </th>
                                <th class="toptable">
                                    Defective Test
                                </th>
                                <th class="toptable">
                                    Conforming
                                </th>
                                <th class="toptable">
                                    Non Conforming
                                </th>
                                <th class="toptable">
                                    Hist. P
                                </th>
                                <th class="toptable">
                                    Data Entry
                                </th>
                                <th class="toptable">
                                    Analysis
                                </th>                                
                            </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td class="toptable"><a href="{% url 'admin:app1_mapdefectivespcscheme_change' scheme.pk %}" target="_blank">{{scheme.pk}}</a></td>
                            <td class="toptable">{{ scheme.equipment }}</td>
                            <td class="toptable">{{ scheme.part }}</td>
                            <td class="toptable">{{ scheme.defective_test.name}}</td>
                            <td class="toptable">{{ scheme.defective_test.conforming_units_code}}</td>
                            <td class="toptable">{{ scheme.defective_test.non_conforming_units_code }}</td>
                            <td class="toptable">{{ scheme.historical_defective_rate}}</td>
                            <td class="toptable"><a href="{% url 'app1:dataentry_defective' scheme.pk %}">Single</a> | <a href="{% url 'app1:dataentry_defective_bulk' scheme.pk %}">Bulk</a></td>
                            <td class="toptable"><a href="{% url 'app1:pchart_analysis' scheme.pk %}">{{scheme.chart_options}} Chart</a> | <a href="{% url 'app1:realtime_pchart_refresh' scheme.pk %}">Auto Refresh</a></td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </div>
                     
            <div id="chartDiv" style="width: 100%; height: 400px;"></div>
            <div id="gridDiv" class="ag-theme-alpine" style="display: none; width: 100%; height: 400px;"></div>
            <div id="errorDiv" style="width: 100%; height: 200px;"></div>

        </div>
        {% if hide_right_sidebar %}
        {% else %}
        <div class="col-md-3 r-box">
            <form  id="analysisForm"  mcguffin="form-group" action="" method="post" class="form-group" style="text-align: center;">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active">
                            <div class="row">
                                <div class="col-md-12 mt-3">
                                    <table class="table text-left table-bordered table-sm table-hover">
                                        {% csrf_token %}
                                        {% if form.errors %}
                                        {{ form.errors }}
                                        {% endif %}
                                        <tr>
                                            <td style="vertical-align: middle;"> Timezone </td>
                                            <td>{{work_unit_timezone}}</td>
                                        </tr>
                                        <tr>
                                            <td style="vertical-align: middle;">Last N Records</td>
                                            <td>
                                                <input type="number" id="last_n_records" name="last_n_records" value="31" min="1" max="3000">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="vertical-align: middle;">Refresh Rate (minutes)</td>
                                            <td><input type="number" id="refresh_rate" name="refresh_rate" value="1" step="0.1" min="0.5" max="30"></td>
                                        </tr>
                                        {% if scheme.historical_defective_rate %}
                                        <tr>
                                            <td style="vertical-align: middle;">Use historical P </td>
                                            <td><input type="checkbox" id="use_historical_p" name="use_historical_p" ></td>
                                        </tr>
                                        {% endif %}
                                        <!-- <tr>
                                            <td>Generate {{scheme.chart_options}} Chart</td>
                                            <td>{{form.generate_p_chart}}</td>
                                        </tr> -->
                                         <tr>
                                            <td style="vertical-align: middle;">Display Raw Data</td>
                                            <td><input type="checkbox" id="display_raw_data" name="display_raw_data"></td>
                                        </tr>
                                        <!-- <tr>
                                            <td>Hide Sidebar</td>
                                            <td><input type="checkbox" id="hide_sidebar" name="hide_sidebar"></td>
                                        </tr> -->
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    <!-- <input type="submit" name="Submit" class="r-button" value="Submit"> -->
            </form>
                <div class="text-left">
                    <p class="section-header">Quick Navigation</p>
                    {{group_data_entry_df_html | safe}}
                    {{related_variable_schemes_df_html | safe}}
                    {{related_defective_schemes_df_html | safe}}
                    {{related_defect_schemes_df_html | safe}}
                </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // function validateRefreshRate(input) {
    //     let value = parseFloat(input.value);

    //     if (value < 0.1) {
    //         input.value = 0.1;
    //     } else if (value > 30) {
    //         input.value = 30;
    //     }
    // }
    var schemeId = "{{ scheme_id }}";
    var intervalId;
    // Define the endpoint using Django's url template tag
    var endpoint = "{% url 'app1:realtime_pchart_data' scheme_id %}";
    var periodEndpoint = "{% url 'app1:pchart_data_by_period' scheme_id %}";
    
    function fetchData() {
        // Get the checkbox state
        // var useHistoricalP = "{{historical_p | safe }}";
        var useHistoricalP = $('#use_historical_p').is(':checked');
        var includeRawData = $('#display_raw_data').is(':checked');
        var lastNRecords = $('#last_n_records').val() || 31; // default 31
        var url = endpoint  + '?use_historical_p=' + useHistoricalP 
                            + '&include_raw_data=' + includeRawData
                            + '&last_n_records=' + lastNRecords;

        var loginUrl = "{{ login_url | safe}}";
        var chart_type = "{{chart_option | safe}}"
        var graph_title = "{{graph_title | safe}}"

        $.ajax({
            url: url,
            method: 'GET',
            // success: function(response) {
            //     plotChart(response.data, response.historical_p,chart_type,graph_title);
            //     if (response.raw_data && includeRawData) {
            //         displayRawData(response.raw_data,response.relevant_choice_keys,response.relevant_text_keys);
            //     } else {
            //         $('#gridDiv').hide();
            //     }
            // },

            success: function(response) {
                // If API sent an error message, show it and stop further chart rendering
                if (response.error_msg) {
                    $('#errorDiv').html(`
                        <div style="
                            border: 1px solid #ccc;
                            background-color: #fef4f4;
                            color: #333;
                            padding: 20px;
                            margin-top: 20px;
                            border-radius: 8px;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            max-width: 900px;
                        ">
                            <h2 style="margin-top: 0; color: #c00;">${response.error_msg}</h2>
                        </div>
                    `);
                    $('#chartDiv').hide();
                    $('#gridDiv').hide();
                    return; // Stop here
                }

                // No error â€” clear errorDiv and show chart
                $('#errorDiv').empty();
                $('#chartDiv').show();

                plotChart(response.data, response.historical_p,chart_type,graph_title);

                if (response.raw_data && includeRawData) {
                    displayRawData(response.raw_data,response.relevant_choice_keys,response.relevant_text_keys);
                } else {
                    $('#gridDiv').hide();
                }
            },

            error: function(xhr, status, error) {
                if (xhr.status === 401 || xhr.status === 403) {  // Handle both 401 and 403
                    $('#errorDiv').html(`
                        <div style="
                            border: 1px solid #ccc;
                            background-color: #fef4f4;
                            color: #333;
                            padding: 20px;
                            margin-top: 20px;
                            border-radius: 8px;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            max-width: 900px;
                        ">
                            <h3 style="margin-top: 0; color: #c00;">Session Expired</h3>
                            <p >
                                You have been logged out due to inactivity or session expiration.
                                Please <a href="${loginUrl}" id="loginRedirect" style="color: #007BFF; text-decoration: underline;">Log in</a> to continue accessing the real-time P chart.
                            </p>
                            <p style="margin-top: 10px; ">
                                You will be automatically redirected to the Loginpage in <strong style="color: #007BFF">60 seconds</strong>.
                            </p>
                        </div>
                    `);

                    // Stop auto-refresh
                    if (intervalId) {
                        clearInterval(intervalId);
                        intervalId = null;
                    }

                    $('#analysisForm').hide(); 
                    $('#gridDiv').hide();
                    $('#chartDiv').hide();  

                    // Redirect after 60 seconds to homepage
                    setTimeout(function() {
                        window.location.href = window.location.pathname;
                    }, 60 * 1000);

                    // Redirect immediately if user clicks the "Login again" link
                    $(document).on('click', '#loginRedirect', function(e) {
                        e.preventDefault();
                        window.location.href = window.location.pathname;
                    });
                } else {
                    console.error('Unexpected error:', xhr.status, error);
                    $('#chartDiv').html('An error occurred while fetching data.');
                }
            }

        });
    }

    function plotChart(data, historical_p, chart_type, graph_title) {
        if (data.length < 4) {
            $('#chartDiv').html('Not enough data for ' + chart_type + ' chart');
            return;
        }
        const xRange = Array.from({ length: data.length }, (_, i) => i + 1);
        const dates = data.map(d => d.sample_date_time);
        let p_i, cl, sd, lcl, ucl, yLabel, yData;

        // Calculate process proportion if not provided
        const process_proportion = historical_p !== undefined
            ? historical_p
            : data.reduce((sum, d) => sum + d.defective_count, 0) / data.reduce((sum, d) => sum + d.sample_size, 0);

        if (chart_type === 'P') {
            // P Chart: Proportion defective
            p_i = data.map(d => d.defective_count / d.sample_size);
            cl = Array(data.length).fill(process_proportion);
            sd = data.map(d => Math.sqrt(process_proportion * (1 - process_proportion) / d.sample_size));
            lcl = sd.map(s => Math.max(0, process_proportion - 3 * s));
            ucl = sd.map(s => process_proportion + 3 * s);
            // yLabel = 'Proportion Defective';
            yData = p_i;
        } else if (chart_type === 'NP') {
            // NP Chart: Number of defectives
            p_i = data.map(d => d.defective_count);
            cl = data.map(d => process_proportion * d.sample_size);
            sd = data.map(d => Math.sqrt(process_proportion * (1 - process_proportion) * d.sample_size));
            lcl = sd.map((s, i) => Math.max(0, cl[i] - 3 * s));
            ucl = sd.map((s, i) => cl[i] + 3 * s);
            // yLabel = 'Number of Defectives';
            yData = p_i;
        } else if (chart_type === 'Laney_P') {
            // Laney P' Chart: Adjusts for overdispersion
            p_i = data.map(d => d.defective_count / d.sample_size);
            cl = Array(data.length).fill(process_proportion);
            const z_scores = data.map(d => Math.sqrt(process_proportion * (1 - process_proportion) / d.sample_size));
            const p_sd = data.map((d, i) => (d.defective_count / d.sample_size - process_proportion) / z_scores[i]);
            const mr = p_sd.slice(1).map((z, i) => Math.abs(z - p_sd[i]));
            const mr_avg = mr.reduce((sum, val) => sum + val, 0) / mr.length;
            const sigma_z = mr_avg / 1.128;
            lcl = z_scores.map(z => Math.max(0, process_proportion - 3 * z * sigma_z));
            ucl = z_scores.map(z => Math.min(1, process_proportion + 3 * z * sigma_z));
            // yLabel = 'Proportion Defective';
            yData = p_i;
        } else {
            const availableCharts = ['P', 'NP','LaneyP'];  // current available options
            $('#chartDiv').html(`
                <div style="
                    border: 1px solid #ccc;
                    background-color: #fef4f4;
                    color: #333;
                    padding: 20px;
                    margin-top: 20px;
                    border-radius: 8px;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    max-width: 900px;
                ">
                    <h3 style="margin-top: 0; color: #c00;">
                        Available chart types: ${availableCharts.join(', ')}
                    </h3>
                </div>
            `);

            return;
        }

        // Rule 1: Points outside control limits
        function getIndices(conditionFn) {
            return yData.map((p, i) => conditionFn(p, i) ? i : null).filter(i => i !== null);
        }

        const rule1Above = getIndices((p, i) => p > ucl[i]);
        const rule1Below = getIndices((p, i) => p < lcl[i]);

        // Rule 2: 9 consecutive points above/below centerline
        function getConsecutiveRuleIndices(conditionFn, runLength) {
            let result = [];
            let currentRun = [];
            for (let i = 0; i < yData.length; i++) {
                if (conditionFn(yData[i], cl[i])) {
                    currentRun.push(i);
                    if (currentRun.length >= runLength) {
                        result.push(...currentRun);
                    }
                } else {
                    currentRun = [];
                }
            }
            return [...new Set(result)].sort();
        }

        const rule2Above = getConsecutiveRuleIndices((pi, cl) => pi > cl, 9);
        const rule2Below = getConsecutiveRuleIndices((pi, cl) => pi < cl, 9);

        // Rule 3: 6 consecutive increasing/decreasing points
        function getIncreasingDecreasingIndices(k = 6) {
            let increasing = new Set();
            let decreasing = new Set();
            for (let i = 0; i <= yData.length - k; i++) {
                let inc = true, dec = true;
                for (let j = i; j < i + k - 1; j++) {
                    if (yData[j] >= yData[j + 1]) inc = false;
                    if (yData[j] <= yData[j + 1]) dec = false;
                }
                if (inc) for (let j = i; j < i + k; j++) increasing.add(j);
                if (dec) for (let j = i; j < i + k; j++) decreasing.add(j);
            }
            return {
                increasing: [...increasing],
                decreasing: [...decreasing]
            };
        }

        const { increasing: rule3Increasing, decreasing: rule3Decreasing } = getIncreasingDecreasingIndices();

        // Rule 4: 14 alternating points
        function getAlternatingIndices(k = 14) {
            let alternating = new Set();
            for (let i = 0; i <= yData.length - k; i++) {
                let valid = true;
                for (let j = i; j < i + k - 2; j++) {
                    if ((yData[j + 1] - yData[j]) * (yData[j + 2] - yData[j + 1]) >= 0) {
                        valid = false;
                        break;
                    }
                }
                if (valid) for (let j = i; j < i + k; j++) alternating.add(j);
            }
            return [...alternating];
        }

        const rule4Alternating = getAlternatingIndices();

        // Helper to create traces for rule violations
        function createRuleTrace(name, indices, color, symbol) {
            return {
                x: indices.map(i => xRange[i]),
                y: indices.map(i => yData[i]),
                type: 'scatter',
                mode: 'markers',
                name,
                marker: { color, size: 9, symbol }
            };
        }

        const traces = [
            {
                x: xRange, y: yData, type: 'scatter', mode: 'lines+markers', name: 'Observations',
                line: { color: 'cornflowerblue' }, marker: { size: 7 }, opacity: 0.8, line_width: 1
            },
            { x: xRange, y: cl, type: 'scatter', mode: 'lines', name: 'CL', line: { dash: 'dot', color: 'black', shape: 'hvh' }, opacity: 0.8, showlegend: false },
            { x: xRange, y: lcl, type: 'scatter', mode: 'lines', name: 'LCL', line: { color: 'red', shape: 'hvh' }, opacity: 0.8, showlegend: false },
            { x: xRange, y: ucl, type: 'scatter', mode: 'lines', name: 'UCL', line: { color: 'red', shape: 'hvh' }, opacity: 0.8, showlegend: false },
            createRuleTrace('Rule-1: Point Above UCL', rule1Above, 'red', 'circle'),
            createRuleTrace('Rule-1: Point Below LCL', rule1Below, 'red', 'circle'),
            createRuleTrace('Rule-2: Points Above CL', rule2Above, 'orange', 'circle'),
            createRuleTrace('Rule-2: Points Below CL', rule2Below, 'orange', 'circle'),
            createRuleTrace('Rule-3: Points Increasing', rule3Increasing, 'rosybrown', 'circle'),
            createRuleTrace('Rule-3: Points Decreasing', rule3Decreasing, 'rosybrown', 'circle'),
            createRuleTrace('Rule-4: Points Alternating', rule4Alternating, 'indianred', 'circle'),
        ];

        const layout = {
            showlegend: true,
            title: { text: graph_title, x: 0.5 },
            xaxis: {
                tickangle: 45,
                tickmode: 'array',
                tickvals: xRange,
                ticktext: dates,
                automargin: true,
                showline: true,
                linewidth: 1,
                linecolor: 'black',
                mirror: false,
                ticks: 'outside',
                gridcolor: 'rgba(0,0,0,0)',
                tickfont: { size: 10 },
                zeroline: false,
                autorange: true
            },
            yaxis: {
                title: yLabel,
                range: [Math.max(0, Math.min(...yData) - 0.02), Math.min(chart_type === 'P' || chart_type === 'Laney_P' ? 1 : Math.max(...yData) + 0.02, Math.max(...yData) + 0.02)],
                automargin: true,
                showline: true,
                linewidth: 1,
                linecolor: 'black',
                mirror: false,
                gridcolor: 'rgba(0,0,0,0)',
                zeroline: false,
                autorange: true,
                ticks: 'outside'
            },
            annotations: [
                {
                    x: xRange[xRange.length - 1],
                    y: ucl[ucl.length - 1],
                    text: `UCL=${ucl[ucl.length - 1].toFixed(3)}`,
                    showarrow: true,
                    arrowhead: 1, arrowsize: 1, arrowwidth: 1, arrowcolor: "#636363",
                    ax: 55,
                    ay: 0,
                    font: { size: 10, color: 'black', family: 'Courier New, monospace' },
                    align: 'right'
                },
                {
                    x: xRange[xRange.length - 1],
                    y: cl[cl.length - 1],
                    text: `CL=${cl[cl.length - 1].toFixed(3)}`,
                    showarrow: true,
                    arrowhead: 1, arrowwidth: 1, arrowcolor: "#636363",
                    ax: 55,
                    ay: 0,
                    font: { size: 10, color: 'black', family: 'Courier New, monospace' },
                    align: 'right'
                },
                {
                    x: xRange[xRange.length - 1],
                    y: lcl[lcl.length - 1],
                    text: `LCL=${lcl[lcl.length - 1].toFixed(3)}`,
                    showarrow: true,
                    arrowhead: 1, arrowwidth: 1, arrowcolor: "#636363",
                    ax: 55,
                    ay: 0,
                    font: { size: 10, color: 'black', family: 'Courier New, monospace' },
                    align: 'right'
                }
            ],
            margin: { l: 50, r: 50, t: 50, b: 100 },
            legend: { orientation: 'v', x: 1.02, y: 1, xanchor: 'left', yanchor: 'top', bgcolor: 'rgba(255, 255, 255, 0.8)' },
            plot_bgcolor: 'rgba(0,0,0,0)',
            itemwidth: 500,
            hovermode: 'closest',
            shapes: [
                {
                    type: 'rect',
                    x0: 0,
                    y0: 0,
                    x1: 1,
                    y1: 1,
                    xref: 'paper',
                    yref: 'paper',
                    line: { color: 'black', width: 1 },
                    fillcolor: 'rgba(0,0,0,0)'
                }
            ]
        };

        if (data.length > 30) {
            const tickInterval = Math.ceil(data.length / 30);
            layout.xaxis.tickvals = xRange.filter((_, i) => i % tickInterval === 0);
            layout.xaxis.ticktext = dates.filter((_, i) => i % tickInterval === 0);
        }

        const modebar = {
            modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'zoom2d', 'resetScale2d', 'hoverClosestCartesian', 'hoverCompareCartesian', 'toggleSpikelines', 'drawline', 'drawopenpath', 'drawclosedpath', 'drawcircle', 'drawrect', 'eraseshape', 'zoom3d', 'pan3d', 'orbitRotation', 'tableRotation', 'handleDrag3d', 'resetCameraDefault3d', 'resetCameraLastSave3d', 'hoverClosest3d', 'zoomInGeo', 'zoomOutGeo', 'resetGeo', 'hoverClosestGeo', 'hoverClosestGl2d', 'hoverClosestPie', 'toggleHover', 'resetViews', 'sendDataToCloud'],
            displaylogo: false,
            displayModeBar: true
        };

        Plotly.newPlot('chartDiv', traces, layout, modebar);
    }

    function displayRawData(rawData,relevant_choice_keys,relevant_text_keys) {
        let timezone = "{{ work_unit_timezone | safe}}"
        const datetime = 'Sample Time('.concat(timezone,')')
        const updationtime = 'Updated('.concat(timezone,')')
        const relevantChoiceKeys = relevant_choice_keys || [];
        const relevantTextKeys = relevant_text_keys || [];

        const columnDefs = [
            {headerName: 'Edit', field: 'Edit', width: 80,maxWidth: 100, floatingFilter:false,
                cellRenderer: function (params) {
                    if (params.value) {
                        const div = document.createElement('div');
                        div.innerHTML = params.value;
                        return div.firstElementChild.outerHTML;
                    }
                    return '';
                    },},
                
                {headerName: datetime, field: 'sample_date_time'},
                {headerName: updationtime, field: 'updation_time'},
                {headerName: 'Sample Size', field: 'sample_size'},
                {headerName: 'Defectives Count', field: 'defective_count'},
                {headerName: 'Batch/Lot', field: 'lot_no'},
                {headerName: 'Sample Id', field: 'sample_id'},
                {headerName: 'Remarks', field: 'remarks'},
                {headerName: 'Cause', field: 'causes'},
                // {headerName: 'Id', field: 'id'},
        ];
        // Dynamically add choice fields to column definitions
        relevantChoiceKeys.forEach(key => {
            columnDefs.push({ headerName: key, field: key });
        });

        relevantTextKeys.forEach(key => {
            columnDefs.push({ headerName: key, field: key });
        });


        const gridOptions = {
            onGridReady:function(params){
                       params.columnApi.autoSizeAllColumns();
            },
            columnDefs: columnDefs,
            rowData: rawData,
            // defaultColDef: { sortable: true, filter: true }
            defaultColDef:{
                editable: false,
                filter: true,
                // flex:1,
                // maxWidth: 180,
                resizable: true,
                wrapText:false,
                autoHeight:false,
                sortable:true,
                floatingFilter: true,
                filter: 'agMultiColumnFilter',
            },
            enableRangeSelection:true,
            suppressLastEmptyLineOnPaste:true,

        };

        const gridDiv = document.querySelector('#gridDiv');
        
        if (gridDiv.children.length > 0) {
            gridDiv.innerHTML = '';
        }
        new agGrid.Grid(gridDiv, gridOptions);
        $('#gridDiv').show();
    }

    function setRefreshInterval() {
        var minutes = parseFloat($('#refresh_rate').val());
        // Clamp the value between 0.5 and 30
        if (minutes < 0.5) {
            minutes = 0.5;
            $('#refresh_rate').val(minutes); // update the input field
        } else if (minutes > 30) {
            minutes = 30;
            $('#refresh_rate').val(minutes); // update the input field
        }
        if (minutes > 0) {
            var interval = minutes * 60 * 1000;
            if (intervalId) {
                clearInterval(intervalId);
            }
            intervalId = setInterval(fetchData, interval);
        } else if (intervalId) {
            clearInterval(intervalId);
        }
    }

    $('#last_n_records').change(function() {
        var value = parseInt($(this).val(), 10); // check base int val
        if (isNaN(value) || value < 5 || value > 3000) {
            alert("Please enter a value between 5 and 3000.");
            $(this).val(31); // reset to default
            return; // stop execution
        }
        fetchData();
    });

    $('#refresh_rate').change(function() {
        setRefreshInterval();
    });

    $('#use_historical_p').change(function() {
        fetchData();
    });

    $('#display_raw_data').change(function() {
        fetchData();
    });

    $('#hide_sidebar').change(function() {
        $('.r-box').toggle(!$(this).is(':checked'));
    });

    // Initial setup
    fetchData();
    setRefreshInterval();
</script>

<style>
    .error-message {
        color: red;
        font-weight: bold;
        display: block;
        text-align: center;
        font-size: 1.25em; /* Equivalent to h1 */
    }
</style>
{% endblock content %}