{% extends "admin/base.html" %}
{% block extrahead %}
{% load static %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"/> 
<script src="https://storage.googleapis.com/zometric220818_qtools/staticfiles/agrid/30.0.6_dist_ag-grid-enterprise.js"></script> 
<title>Data Entry Defective</title>

{% endblock extrahead %}
{% block content_title %}{% endblock %}
{% block content %}
<div class="container-fluid1">
    <div class="row">
        <div class="{% if hide_right_sidebar %} col-md-12 {% else %} col-md-9 {% endif %}">
            <div class="row">
                <div class="col-md-12">
                    <table class="table table-bordered table-sm table-hover">
                        <thead class="toptable">
                            <tr>
                                <th class="toptable">
                                    S#
                                </th>
                                <th class="toptable">
                                    Equipment
                                </th>
                                <th class="toptable">
                                    Part
                                </th>
                                <th class="toptable">
                                    Defective Test 
                                </th>
                                <th class="toptable">
                                    Conforming
                                </th>
                                <th class="toptable">
                                    Non Conforming
                                </th>
                                <th class="toptable">
                                    Hist. P
                                </th>
                                <th class="toptable">
                                    Data Entry
                                </th>
                                <th class="toptable">
                                    Analysis
                                </th>                                
                            </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td class="toptable"><a href="{% url 'admin:app1_mapdefectivespcscheme_change' scheme.pk %}" target="_blank">{{scheme.pk}}</a></td>
                            <td class="toptable">{{ scheme.equipment }}</td>
                            <td class="toptable">{{ scheme.part }}</td>
                            <td class="toptable">{{ scheme.defective_test.name}}</td>
                            <td class="toptable">{{ scheme.defective_test.conforming_units_code}}</td>
                            <td class="toptable">{{ scheme.defective_test.non_conforming_units_code }}</td>
                            <td class="toptable">{{ scheme.historical_defective_rate}}</td>
                            <td class="toptable"><a href="{% url 'app1:dataentry_defective' scheme.pk %}">Single</a> | <a href="{% url 'app1:dataentry_defective_bulk' scheme.pk %}">Bulk</a></td>
                            <td class="toptable"><a href="{% url 'app1:pchart_analysis' scheme.pk %}">{{scheme.chart_options}} Chart</a></td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    {% if error_msg %}
                    <span class="error-message">
                        {{ error_msg }}
                    </span>
                    {% endif %}
                    {% if chart_msg %}
                        {{chart_msg}}
                    {% endif %}
                    {{fig | safe}}
                </div>

                <div id="chartDiv"></div>

                <script>
                    var schemeId = "{{ scheme_id }}";
                    var intervalId;
                    // Define the endpoint using Django's url template tag
                    var endpoint = "{% url 'app1:realtime_pchart_refresh' scheme_id %}";

                    function fetchData() {
                        // Get the checkbox state
                        var useHistoricalP = $('#use_historical_p').is(':checked');
                        // Append the query parameter to the endpoint
                        var url = endpoint + '?use_historical_p=' + useHistoricalP;
                        
                        $.ajax({
                            url: url,
                            method: 'GET',
                            success: function(response) {
                                // Plot the chart with the response data
                                plotChart(response.data, response.historical_p);
                            },
                            error: function(error) {
                                // Log any errors
                                console.error('Error fetching data:', error);
                            }
                        });
                    }

                                        
                function plotChart(data, historical_p) {
                    if (data.length < 4) {
                        $('#chartDiv').html('Not enough data for P chart');
                        return;
                    }

                    // Parse ISO timestamps into Date objects
                    var dates = data.map(d => new Date(d.sample_date_time));
                    console.log(dates, 'converted dates for Plotly');

                    // Calculate proportions and control limits per subgroup
                    var p_i = data.map(d => d.defective_count / d.sample_size);
                    var process_proportion = historical_p !== undefined ? historical_p : data.reduce((sum, d) => sum + d.defective_count, 0) / data.reduce((sum, d) => sum + d.sample_size, 0);
                    var p_cl = Array(data.length).fill(process_proportion);
                    var p_sd = data.map(d => Math.sqrt(process_proportion * (1 - process_proportion) / d.sample_size));
                    var p_lcl = p_sd.map(sd => Math.max(0, process_proportion - 3 * sd));
                    var p_ucl = p_sd.map(sd => process_proportion + 3 * sd);

                    // SPC Rules (unchanged for brevity)
                    var rule1Above = p_i.map((p, i) => p > p_ucl[i] ? i : null).filter(i => i !== null);
                    var rule1Below = p_i.map((p, i) => p < p_lcl[i] ? i : null).filter(i => i !== null);
                    var rule2Above = [];
                    var rule2Below = [];
                    for (let i = 0; i <= p_i.length - 9; i++) {
                        if (p_i.slice(i, i + 9).every(p => p > process_proportion)) rule2Above.push(...Array.from({ length: 9 }, (_, j) => i + j));
                        if (p_i.slice(i, i + 9).every(p => p < process_proportion)) rule2Below.push(...Array.from({ length: 9 }, (_, j) => i + j));
                    }
                    var rule3Increasing = [];
                    var rule3Decreasing = [];
                    for (let i = 0; i <= p_i.length - 6; i++) {
                        if (p_i[i] < p_i[i + 1] && p_i[i + 1] < p_i[i + 2] && p_i[i + 2] < p_i[i + 3] && p_i[i + 3] < p_i[i + 4] && p_i[i + 4] < p_i[i + 5]) {
                            rule3Increasing.push(i, i + 1, i + 2, i + 3, i + 4, i + 5);
                        }
                        if (p_i[i] > p_i[i + 1] && p_i[i + 1] > p_i[i + 2] && p_i[i + 2] > p_i[i + 3] && p_i[i + 3] > p_i[i + 4] && p_i[i + 4] > p_i[i + 5]) {
                            rule3Decreasing.push(i, i + 1, i + 2, i + 3, i + 4, i + 5);
                        }
                    }
                    var rule4Alternating = [];
                    for (let i = 0; i <= p_i.length - 14; i++) {
                        let alternating = true;
                        for (let j = 0; j < 13; j++) {
                            if ((p_i[i + j] > p_i[i + j + 1] && p_i[i + j + 1] > p_i[i + j + 2]) || (p_i[i + j] < p_i[i + j + 1] && p_i[i + j + 1] < p_i[i + 2])) {
                                alternating = false;
                                break;
                            }
                        }
                        if (alternating) rule4Alternating.push(...Array.from({ length: 14 }, (_, j) => i + j));
                    }

                    // Define traces
                    var trace1 = { x: dates, y: p_i, type: 'scatter', mode: 'lines+markers', name: 'Observations', line: { color: 'cornflowerblue', width: 1 }, marker: { size: 8, color: 'cornflowerblue' } };
                    var trace2 = { x: dates, y: p_cl, type: 'scatter', mode: 'lines', name: 'Center Line', line: { dash: 'dot', color: 'black' }, showlegend: false };
                    var trace3 = { x: dates, y: p_lcl, type: 'scatter', mode: 'lines', name: 'LCL', line: { color: 'red' }, showlegend: false };
                    var trace4 = { x: dates, y: p_ucl, type: 'scatter', mode: 'lines', name: 'UCL', line: { color: 'red' }, showlegend: false };
                    var rule1AboveTrace = { x: rule1Above.map(i => dates[i]), y: rule1Above.map(i => p_i[i]), type: 'scatter', mode: 'markers', name: 'Rule-1: Point above UCL', marker: { color: 'red', size: 10 } };
                    var rule1BelowTrace = { x: rule1Below.map(i => dates[i]), y: rule1Below.map(i => p_i[i]), type: 'scatter', mode: 'markers', name: 'Rule-1: Point below LCL', marker: { color: 'red', size: 10 } };
                    var rule2AboveTrace = { x: rule2Above.map(i => dates[i]), y: rule2Above.map(i => p_i[i]), type: 'scatter', mode: 'markers', name: 'Rule-2: 9 points above CL', marker: { color: 'orange', size: 10 } };
                    var rule2BelowTrace = { x: rule2Below.map(i => dates[i]), y: rule2Below.map(i => p_i[i]), type: 'scatter', mode: 'markers', name: 'Rule-2: 9 points below CL', marker: { color: 'orange', size: 10 } };
                    var rule3IncreasingTrace = { x: rule3Increasing.map(i => dates[i]), y: rule3Increasing.map(i => p_i[i]), type: 'scatter', mode: 'markers', name: 'Rule-3: 6 points increasing', marker: { color: 'rosybrown', size: 10 } };
                    var rule3DecreasingTrace = { x: rule3Decreasing.map(i => dates[i]), y: rule3Decreasing.map(i => p_i[i]), type: 'scatter', mode: 'markers', name: 'Rule-3: 6 points decreasing', marker: { color: 'rosybrown', size: 10 } };
                    var rule4Trace = { x: rule4Alternating.map(i => dates[i]), y: rule4Alternating.map(i => p_i[i]), type: 'scatter', mode: 'markers', name: 'Rule-4: 14 points alternating', marker: { color: 'indianred', size: 10 } };

                    // Create ticktext with full timestamps (date and time)
                    var ticktext = dates.map(date => date.toLocaleString('en-IN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }));

                    // Define layout with explicit tickvals and ticktext
                    var layout = {
                        title: { text: 'P Chart: defect2 of p2 @ eqp3', x: 0.5, xanchor: 'center' },
                        xaxis: {
                            title: 'Date and Time',
                            type: 'date',
                            tickmode: 'array',  // Explicitly set ticks
                            tickvals: dates,    // One tick per data point
                            ticktext: ticktext, // Full timestamp labels
                            tickangle: 45,      // Rotate labels for readability
                            tickfont: { size: 10 },
                            showgrid: false,
                            zeroline: false
                        },
                        yaxis: {
                            title: 'Proportion',
                            range: [0, Math.max(0.4, Math.max(...p_ucl) + 0.05)],
                            tickfont: { size: 10 },
                            showgrid: true,
                            zeroline: true
                        },
                        margin: { l: 50, r: 50, b: 150, t: 60 }, // Increased bottom margin for labels
                        width: 1200,                            // Wider chart for spacing
                        height: 500,
                        plot_bgcolor: "rgba(0,0,0,0)",
                        annotations: [
                            { x: dates[dates.length - 10], y: p_ucl[p_ucl.length - 1], text: `UCL=${p_ucl[p_ucl.length - 1].toFixed(3)}`, showarrow: false, font: { size: 10, color: 'red' }, xanchor: 'left' },
                            { x: dates[dates.length - 10], y: p_cl[0], text: `CL=${p_cl[0].toFixed(3)}`, showarrow: false, font: { size: 10, color: 'black' }, xanchor: 'left' },
                            { x: dates[dates.length - 10], y: p_lcl[p_lcl.length - 1], text: `LCL=${p_lcl[p_lcl.length - 1].toFixed(3)}`, showarrow: false, font: { size: 10, color: 'red' }, xanchor: 'left' }
                        ]
                    };

                    // Render the chart
                    Plotly.newPlot('chartDiv', [
                        trace1, trace2, trace3, trace4,
                        rule1AboveTrace, rule1BelowTrace,
                        rule2AboveTrace, rule2BelowTrace,
                        rule3IncreasingTrace, rule3DecreasingTrace,
                        rule4Trace
                    ], layout);
                }
                   
                function setRefreshInterval() {
                    var minutes = parseInt($('#refresh_interval').val());
                    if (minutes > 0) {
                        var interval = minutes * 60 * 1000;
                        if (intervalId) {
                            clearInterval(intervalId);
                        }
                        intervalId = setInterval(fetchData, interval);
                    }
                }

                $('#set_interval').click(setRefreshInterval);
                $('#use_historical_p').change(fetchData);
                // Initial setup
                fetchData();
                setRefreshInterval();
                </script>

            </div>            
          
        </div>
        {% if hide_right_sidebar %}
        {% else %}
        <!-- <div class="col-md-3 r-box">
            <form action="" method="post" class="form-group" style="text-align: center;">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active">
                            <div class="row">
                                <div class="col-md-12 mt-3">
                                    <table class="table text-left table-bordered table-sm table-hover">
                                        {% csrf_token %}
                                        {% if form.errors %}
                                        {{ form.errors }}
                                        {% endif %}
                                        <tr>
                                            <td> Timezone </td>
                                            <td>{{work_unit_timezone}}</td>
                                        </tr>
                                        <tr>
                                            <td style="vertical-align: middle;">From</td>
                                            <td>{{form.start_date_time}}</td>
                                        </tr>
                                        <tr>
                                            <td style="vertical-align: middle;">To</td>
                                            <td>{{form.end_date_time}}</td>
                                        </tr>
                                    </table>
                                    <table class="table text-left table-bordered table-sm table-hover">
                                        {% if scheme.historical_defective_rate %}
                                        <tr>
                                            <td>Use historical P </td>
                                            <td> {{form.use_historical_p}}</td>
                                        </tr>
                                        {% endif %}
                                        <tr>
                                            <td>Generate {{scheme.chart_options}} Chart</td>
                                            <td>{{form.generate_p_chart}}</td>
                                        </tr>
                                        <tr>
                                            <td>Display Raw Data</td>
                                            <td>{{form.display_raw_data}}</td>
                                        </tr>
                                        <tr>
                                            <td>Hide Sidebar</td>
                                            <td>{{form.hide_sidebar}}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    <input type="submit" name="Submit" class="r-button" value="Submit">
            </form>
                <div class="text-left">
                    <p class="section-header">Quick Navigation</p>
                    {{group_data_entry_df_html | safe}}
                    {{related_variable_schemes_df_html | safe}}
                    {{related_defective_schemes_df_html | safe}}
                    {{related_defect_schemes_df_html | safe}}
                </div>
        </div> -->
        {% endif %}
    </div>
</div>
<style>
    .error-message {
        color: red;
        font-weight: bold;
        display: block;
        text-align: center;
        font-size: 1.25em; /* Equivalent to h1 */
    }
    #chartDiv {
        width: 100%;
        height: 400px;
    }
</style>
{% endblock content %}